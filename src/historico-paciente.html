<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Histórico do Paciente</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-purple-800 text-white hidden md:block min-h-screen p-4">
    <div class="mb-8">
      <h1 class="text-2xl font-bold mb-2"><i class="fas fa-user-md mr-2"></i>Profissional</h1>
      <nav class="space-y-2">
        <a data-base="dashboardprofissional.html" class="sidebar-link block py-2 px-3 rounded hover:bg-purple-700">Início</a>
        <a data-base="gerir-consultas.html" class="sidebar-link block py-2 px-3 rounded hover:bg-purple-700">Consultas</a>
        <a data-base="historico.html" class="sidebar-link block py-2 px-3 rounded bg-purple-700">Histórico</a>
      </nav>
    </div>
  </aside>

  <!-- Conteúdo principal -->
  <main class="flex-1 p-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-2xl font-bold text-gray-800 mb-4">Histórico do Paciente</h1>

      <!-- Filtros -->
      <div class="bg-white p-4 rounded shadow mb-6 space-y-4">
        <h2 class="text-lg font-semibold text-gray-700">Filtrar por Data</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Mês:</label>
            <input type="month" id="mesFiltro" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Data Início:</label>
            <input type="date" id="dataInicio" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Data Fim:</label>
            <input type="date" id="dataFim" class="w-full border rounded px-3 py-2">
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button id="btnLimpar" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Limpar Filtros</button>
          <button id="btnFiltrar" class="bg-indigo-700 text-white px-4 py-2 rounded hover:bg-indigo-800">Filtrar</button>
        </div>
      </div>

      <div id="historicoList" class="space-y-4"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      orderBy,
      Timestamp,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMwJEeBE1tfT-wVPJ8c2lSlEmuqYEuqnY",
      authDomain: "projeto-final-de-curso-425a9.firebaseapp.com",
      projectId: "projeto-final-de-curso-425a9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    let uid = params.get("uid");

    if (!uid) {
      uid = sessionStorage.getItem("currentPacienteUID");
    } else {
      sessionStorage.setItem("currentPacienteUID", uid);
    }

    document.querySelectorAll(".sidebar-link").forEach(link => {
      const base = link.getAttribute("data-base");
      link.href = uid ? `${base}?uid=${uid}` : base;
    });

    document.getElementById("btnFiltrar").addEventListener("click", carregarHistorico);
    document.getElementById("btnLimpar").addEventListener("click", () => {
      document.getElementById("mesFiltro").value = "";
      document.getElementById("dataInicio").value = "";
      document.getElementById("dataFim").value = "";
      carregarHistorico();
    });

    async function carregarHistorico() {
      const lista = document.getElementById("historicoList");
      lista.innerHTML = "";

      if (!uid) {
        lista.innerHTML = "<p class='text-red-500'>Erro: paciente não especificado.</p>";
        return;
      }

      const mesFiltro = document.getElementById("mesFiltro").value;
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      const hojeTimestamp = Timestamp.fromDate(new Date());

      const consultasQuery = query(
        collection(db, "appointments"),
        where("pacienteId", "==", uid),
        where("data", "<", hojeTimestamp),
        orderBy("data", "desc")
      );

      const observacoesQuery = query(
        collection(db, "observacoes"),
        where("pacienteId", "==", uid),
        orderBy("data", "desc")
      );

      try {
        const [consultasSnapshot, observacoesSnapshot] = await Promise.all([
          getDocs(consultasQuery),
          getDocs(observacoesQuery)
        ]);

        const dataIniFiltro = dataInicio ? new Date(dataInicio) : null;
        const dataFimFiltro = dataFim ? new Date(dataFim) : null;
        const [anoMes] = mesFiltro ? mesFiltro.split("-") : [null, null];

        const filtrarData = (data) => {
          if (!data?.toDate) return false;
          const d = data.toDate();
          if (anoMes) {
            const ano = d.getFullYear().toString();
            const mes = (d.getMonth() + 1).toString().padStart(2, "0");
            if (`${ano}-${mes}` !== mesFiltro) return false;
          }
          if (dataIniFiltro && d < dataIniFiltro) return false;
          if (dataFimFiltro && d > dataFimFiltro) return false;
          return true;
        };

        if (!consultasSnapshot.empty) {
          const consultasFiltradas = consultasSnapshot.docs.filter(doc => filtrarData(doc.data().data));

          if (consultasFiltradas.length > 0) {
            const tituloConsultas = document.createElement("h2");
            tituloConsultas.className = "text-xl font-semibold text-purple-700 mt-6";
            tituloConsultas.textContent = "Consultas Anteriores";
            lista.appendChild(tituloConsultas);

            consultasFiltradas.forEach(doc => {
              const consulta = doc.data();
              const dataFormatada = consulta.data?.toDate().toLocaleDateString("pt-PT") || 'N/A';
              const div = document.createElement("div");
              div.className = "bg-white p-4 rounded shadow";
              div.innerHTML = `
                <p><strong>Data:</strong> ${dataFormatada}</p>
                <p><strong>Hora:</strong> ${consulta.hora || 'N/A'}</p>
                <p><strong>Local:</strong> ${consulta.local || consulta.officeNumber || 'N/A'}</p>
                <p><strong>Especialidade:</strong> ${consulta.especialidade || 'N/A'}</p>
                <p><strong>Assunto:</strong> ${consulta.subject || 'N/A'}</p>
              `;
              lista.appendChild(div);
            });
          }
        }

        if (!observacoesSnapshot.empty) {
          const observacoesFiltradas = observacoesSnapshot.docs.filter(doc => filtrarData(doc.data().data));

          if (observacoesFiltradas.length > 0) {
            const tituloObs = document.createElement("h2");
            tituloObs.className = "text-xl font-semibold text-purple-700 mt-6";
            tituloObs.textContent = "Observações do Profissional";
            lista.appendChild(tituloObs);

            observacoesFiltradas.forEach(doc => {
              const obs = doc.data();
              const dataFormatada = obs.data?.toDate().toLocaleString("pt-PT") || "(sem data)";
              const div = document.createElement("div");
              div.className = "bg-white p-4 rounded shadow";
              div.innerHTML = `
                <p><strong>Data:</strong> ${dataFormatada}</p>
                <p><strong>Observação:</strong> ${obs.texto || 'N/A'}</p>
              `;
              lista.appendChild(div);
            });
          }
        }

        if (lista.innerHTML === "") {
          lista.innerHTML = '<p class="text-gray-500">Nenhum registo corresponde aos filtros aplicados.</p>';
        }

      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        lista.innerHTML = '<p class="text-red-500">Erro ao carregar os dados. Verifique as permissões do Firestore.</p>';
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Utilizador não autenticado. Redirecionar para login.");
        window.location.href = "/src/login1.html";
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists()) {
          alert("Perfil de utilizador não encontrado.");
          return;
        }

        const userData = userDoc.data();
        if (userData.role !== "profissional") {
          alert("Acesso restrito. Esta página é apenas para profissionais.");
          window.location.href = "mainpage.html";
          return;
        }

        carregarHistorico();
      } catch (err) {
        console.error("Erro ao verificar permissões:", err);
        alert("Erro ao verificar permissões. Verifique a consola.");
      }
    });
  </script>
</body>
</html>
